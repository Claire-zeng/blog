{{ define "main" }}
<div class="post-layout">
    <!-- å·¦ä¾§ç›®å½•æ  -->
    <aside class="toc-sidebar">
        <div class="toc-container">
            <h3 class="toc-title">ğŸ“‹ ç›®å½•</h3>
            <div class="toc-content" id="toc">
                <!-- ç›®å½•å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </aside>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">{{ .Title }}</h1>
            <div class="post-meta">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006å¹´1æœˆ2æ—¥" }}</time>
                {{ if .Params.categories }}
                <span class="category">{{ index .Params.categories 0 }}</span>
                {{ end }}
            </div>
            {{ if .Params.tags }}
            <div class="post-tags">
                {{ range .Params.tags }}
                <span class="tag">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
        </header>

        <div class="post-content" id="post-content">
            {{ .Content }}
        </div>

        <footer class="post-footer">
            <div class="post-navigation">
                {{ with .PrevInSection }}
                <a href="{{ .RelPermalink }}" class="prev-post">
                    â† {{ .Title }}
                </a>
                {{ end }}
                {{ with .NextInSection }}
                <a href="{{ .RelPermalink }}" class="next-post">
                    {{ .Title }} â†’
                </a>
                {{ end }}
            </div>
        </footer>
    </article>
</div>

<!-- ç›®å½•ç”Ÿæˆè„šæœ¬ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    generateTOC();
    handleTOCScroll();
});

function generateTOC() {
    const content = document.getElementById('post-content');
    const toc = document.getElementById('toc');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    if (headings.length === 0) {
        document.querySelector('.toc-sidebar').style.display = 'none';
        document.querySelector('.post').style.marginLeft = '0';
        return;
    }
    
    let tocHTML = '<ul class="toc-list">';
    let currentLevel = 0;
    
    headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.charAt(1));
        const text = heading.textContent;
        const id = 'heading-' + index;
        
        // ä¸ºæ ‡é¢˜æ·»åŠ ID
        heading.id = id;
        
        // å¤„ç†å±‚çº§
        if (level > currentLevel) {
            for (let i = currentLevel; i < level; i++) {
                if (i > 0) tocHTML += '<ul class="toc-list">';
            }
        } else if (level < currentLevel) {
            for (let i = currentLevel; i > level; i--) {
                tocHTML += '</ul>';
            }
        }
        
        tocHTML += `<li class="toc-item toc-level-${level}">
                      <a href="#${id}" class="toc-link" data-target="${id}">${text}</a>
                    </li>`;
        
        currentLevel = level;
    });
    
    // å…³é—­æ‰€æœ‰æœªå…³é—­çš„ulæ ‡ç­¾
    for (let i = 0; i < currentLevel; i++) {
        tocHTML += '</ul>';
    }
    
    toc.innerHTML = tocHTML;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
                
                // æ›´æ–°æ´»è·ƒçŠ¶æ€
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
}

function handleTOCScroll() {
    const headings = document.querySelectorAll('#post-content h1, #post-content h2, #post-content h3, #post-content h4, #post-content h5, #post-content h6');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    if (headings.length === 0) return;
    
    window.addEventListener('scroll', function() {
        let currentHeading = '';
        
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                currentHeading = heading.id;
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-target') === currentHeading) {
                link.classList.add('active');
            }
        });
    });
}
</script>
{{ end }}

