{{ define "main" }}
<div class="post-layout">
    <!-- å·¦ä¾§ç›®å½•æ  -->
    <aside class="toc-sidebar" id="toc-sidebar">
        <div class="toc-container">
            <div class="toc-header">
                <h3 class="toc-title">ğŸ“‹ ç›®å½•</h3>
                <button class="toc-toggle" id="toc-toggle" title="éšè—ç›®å½•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="toc-content" id="toc">
                <!-- ç›®å½•å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </aside>

    <!-- ç›®å½•æ˜¾ç¤ºæŒ‰é’®ï¼ˆéšè—çŠ¶æ€æ—¶æ˜¾ç¤ºï¼‰ -->
    <button class="toc-show-btn" id="toc-show-btn" title="æ˜¾ç¤ºç›®å½•">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">{{ .Title }}</h1>
            <div class="post-meta">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006å¹´1æœˆ2æ—¥" }}</time>
                {{ if .Params.categories }}
                <span class="category">{{ index .Params.categories 0 }}</span>
                {{ end }}
            </div>
            {{ if .Params.tags }}
            <div class="post-tags">
                {{ range .Params.tags }}
                <span class="tag">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
        </header>

        <div class="post-content" id="post-content">
            {{ .Content }}
        </div>

        <footer class="post-footer">
            <div class="post-navigation">
                {{ with .PrevInSection }}
                <a href="{{ .RelPermalink }}" class="prev-post">
                    â† {{ .Title }}
                </a>
                {{ end }}
                {{ with .NextInSection }}
                <a href="{{ .RelPermalink }}" class="next-post">
                    {{ .Title }} â†’
                </a>
                {{ end }}
            </div>
        </footer>
    </article>
</div>

<!-- ç›®å½•ç”Ÿæˆè„šæœ¬ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    generateTOC();
    handleTOCScroll();
    initTOCToggle();
});

function generateTOC() {
    const content = document.getElementById('post-content');
    const toc = document.getElementById('toc');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    if (headings.length === 0) {
        document.querySelector('.toc-sidebar').style.display = 'none';
        document.querySelector('.toc-show-btn').style.display = 'none';
        document.querySelector('.post').style.marginLeft = '0';
        return;
    }
    
    // æ„å»ºç›®å½•æ ‘ç»“æ„
    const tocTree = buildTocTree(headings);
    const tocHTML = renderTocTree(tocTree);
    toc.innerHTML = tocHTML;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç›®å½•é“¾æ¥
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
                
                // æ›´æ–°æ´»è·ƒçŠ¶æ€
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
    
    // æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½
    document.querySelectorAll('.toc-toggle-icon').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const parentItem = this.closest('.toc-item');
            const submenu = parentItem.querySelector('.toc-submenu');
            
            if (submenu) {
                const isCollapsed = submenu.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // å±•å¼€
                    submenu.classList.remove('collapsed');
                    this.textContent = 'â–¼';
                    this.classList.remove('collapsed');
                } else {
                    // æŠ˜å 
                    submenu.classList.add('collapsed');
                    this.textContent = 'â–¶';
                    this.classList.add('collapsed');
                }
            }
        });
    });
    
    // é»˜è®¤æŠ˜å è¾ƒæ·±çš„å±‚çº§ï¼ˆh4åŠä»¥ä¸‹ï¼‰
    document.querySelectorAll('.toc-level-4, .toc-level-5, .toc-level-6').forEach(item => {
        const submenu = item.querySelector('.toc-submenu');
        const toggle = item.querySelector('.toc-toggle-icon');
        if (submenu && toggle) {
            submenu.classList.add('collapsed');
            toggle.textContent = 'â–¶';  // å‘å³ç®­å¤´è¡¨ç¤ºæŠ˜å çŠ¶æ€
            toggle.classList.add('collapsed');
        }
    });
}

function buildTocTree(headings) {
    const tree = [];
    const stack = [];
    
    headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.charAt(1));
        const text = heading.textContent;
        const id = 'heading-' + index;
        
        // ä¸ºæ ‡é¢˜æ·»åŠ ID
        heading.id = id;
        
        const node = {
            id,
            text,
            level,
            children: []
        };
        
        // æ‰¾åˆ°æ­£ç¡®çš„çˆ¶èŠ‚ç‚¹
        while (stack.length > 0 && stack[stack.length - 1].level >= level) {
            stack.pop();
        }
        
        if (stack.length === 0) {
            tree.push(node);
        } else {
            stack[stack.length - 1].children.push(node);
        }
        
        stack.push(node);
    });
    
    return tree;
}

function renderTocTree(tree) {
    if (tree.length === 0) return '';
    
    let html = '<ul class="toc-list">';
    
    tree.forEach(node => {
        const hasChildren = node.children.length > 0;
        const toggleIcon = hasChildren ? 
            '<span class="toc-toggle-icon">â–¼</span>' : 
            '<span class="toc-no-children"></span>';
            
        html += `<li class="toc-item toc-level-${node.level}">
                   <div class="toc-item-wrapper">
                       ${toggleIcon}
                       <a href="#${node.id}" class="toc-link" data-target="${node.id}">${node.text}</a>
                   </div>`;
        
        if (hasChildren) {
            html += `<div class="toc-submenu">${renderTocTree(node.children)}</div>`;
        }
        
        html += '</li>';
    });
    
    html += '</ul>';
    return html;
}

function handleTOCScroll() {
    const headings = document.querySelectorAll('#post-content h1, #post-content h2, #post-content h3, #post-content h4, #post-content h5, #post-content h6');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    if (headings.length === 0) return;
    
    window.addEventListener('scroll', function() {
        let currentHeading = '';
        
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                currentHeading = heading.id;
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-target') === currentHeading) {
                link.classList.add('active');
            }
        });
    });
}

function initTOCToggle() {
    const tocSidebar = document.getElementById('toc-sidebar');
    const tocToggle = document.getElementById('toc-toggle');
    const tocShowBtn = document.getElementById('toc-show-btn');
    const postLayout = document.querySelector('.post-layout');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å­˜å‚¨çš„çŠ¶æ€
    const isHidden = localStorage.getItem('toc-hidden') === 'true';
    if (isHidden) {
        hideTOC();
    }
    
    // éšè—ç›®å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    tocToggle.addEventListener('click', function() {
        hideTOC();
        localStorage.setItem('toc-hidden', 'true');
    });
    
    // æ˜¾ç¤ºç›®å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    tocShowBtn.addEventListener('click', function() {
        showTOC();
        localStorage.setItem('toc-hidden', 'false');
    });
    
    function hideTOC() {
        tocSidebar.classList.add('toc-hidden');
        tocShowBtn.classList.add('show');
        postLayout.classList.add('toc-collapsed');
    }
    
    function showTOC() {
        tocSidebar.classList.remove('toc-hidden');
        tocShowBtn.classList.remove('show');
        postLayout.classList.remove('toc-collapsed');
    }
}
</script>
{{ end }}

